# ベンチログ

## 初期状態

### ベンチマーク

```json
{
  "pass": true,
  "score": 315,
  "success": 365,
  "fail": 6,
  "messages": ["リクエストがタイムアウトしました (POST /login)"]
}
```

## 2 回目

### 変更点

- nginx のデバッグログを追加

### ベンチマーク

```json
{
  "pass": true,
  "score": 159,
  "success": 353,
  "fail": 13,
  "messages": [
    "リクエストがタイムアウトしました (GET /favicon.ico)",
    "リクエストがタイムアウトしました (POST /login)",
    "リクエストがタイムアウトしました (POST /register)"
  ]
}
```

### レイテンシ分析

```
+-------+-----+-----+-----+-----+-----+--------+------------------------------+-------+--------+---------+-------+-------+--------+--------+--------+-----------+-------------+--------------+------------+
| COUNT | 1XX | 2XX | 3XX | 4XX | 5XX | METHOD |             URI              |  MIN  |  MAX   |   SUM   |  AVG  |  P90  |  P95   |  P99   | STDDEV | MIN(BODY) |  MAX(BODY)  |  SUM(BODY)   | AVG(BODY)  |
+-------+-----+-----+-----+-----+-----+--------+------------------------------+-------+--------+---------+-------+-------+--------+--------+--------+-----------+-------------+--------------+------------+
|   189 |   0 | 184 |   0 |   5 |   0 | GET    | /image/[0-9]+\.(jpg|png|gif) | 0.002 |  6.920 | 303.934 | 1.608 | 4.444 |  5.042 |  6.915 |  1.708 |     0.000 | 1056749.000 | 38914480.000 | 205896.720 |
|    43 |   0 |  36 |   0 |   7 |   0 | GET    | /                            | 0.076 |  9.954 | 156.411 | 3.637 | 7.823 |  8.613 |  9.954 |  2.467 |     0.000 |   36410.000 |  1263326.000 |  29379.674 |
|    35 |   0 |   0 |  35 |   0 |   0 | POST   | /login                       | 0.003 |  7.804 |  75.560 | 2.159 | 6.622 |  7.786 |  7.804 |  2.643 |     0.000 |       0.000 |        0.000 |      0.000 |
|    17 |   0 |  16 |   0 |   1 |   0 | GET    | /favicon.ico                 | 0.002 | 10.002 |  64.987 | 3.823 | 8.884 | 10.002 | 10.002 |  3.385 |    43.000 |      43.000 |      688.000 |     40.471 |
|    17 |   0 |  15 |   0 |   2 |   0 | GET    | /js/timeago.min.js           | 0.002 |  6.041 |  40.213 | 2.365 | 5.588 |  6.041 |  6.041 |  1.854 |     0.000 |    1915.000 |    28725.000 |   1689.706 |
|    11 |   0 |  11 |   0 |   0 |   0 | GET    | /@[a-z]                      | 0.577 |  7.768 |  35.905 | 3.264 | 7.115 |  7.768 |  7.768 |  2.238 |  7817.000 |   22545.000 |   183956.000 |  16723.273 |
|    13 |   0 |  13 |   0 |   0 |   0 | GET    | /posts/[0-9]+                | 0.075 |  8.565 |  30.001 | 2.308 | 3.911 |  8.565 |  8.565 |  2.129 |  1709.000 |    5617.000 |    46043.000 |   3541.769 |
|    15 |   0 |  14 |   0 |   1 |   0 | GET    | /js/main.js                  | 0.001 |  6.911 |  28.409 | 1.894 | 3.218 |  6.911 |  6.911 |  1.987 |     0.000 |    1824.000 |    25536.000 |   1702.400 |
|     8 |   0 |   0 |   4 |   4 |   0 | POST   | /                            | 0.003 |  4.312 |  11.125 | 1.391 | 4.312 |  4.312 |  4.312 |  1.509 |     0.000 |       0.000 |        0.000 |      0.000 |
|    14 |   0 |  14 |   0 |   0 |   0 | GET    | /css/style.css               | 0.002 |  3.196 |  10.023 | 0.716 | 2.245 |  3.196 |  3.196 |  1.008 |  1549.000 |    1549.000 |    21686.000 |   1549.000 |
|     2 |   0 |   2 |   0 |   0 |   0 | GET    | /posts                       | 1.858 |  5.349 |   7.207 | 3.604 | 5.349 |  5.349 |  5.349 |  1.746 | 33975.000 |   34161.000 |    68136.000 |  34068.000 |
|     7 |   0 |   0 |   6 |   1 |   0 | POST   | /comment                     | 0.006 |  3.568 |   6.311 | 0.902 | 3.568 |  3.568 |  3.568 |  1.228 |     0.000 |       0.000 |        0.000 |      0.000 |
|     6 |   0 |   0 |   0 |   6 |   0 | GET    | /admin/banned                | 0.003 |  1.905 |   4.197 | 0.700 | 1.905 |  1.905 |  1.905 |  0.831 |     0.000 |       0.000 |        0.000 |      0.000 |
|     6 |   0 |   6 |   0 |   0 |   0 | GET    | /login                       | 0.004 |  1.653 |   3.473 | 0.579 | 1.653 |  1.653 |  1.653 |  0.755 |  1234.000 |    1234.000 |     7404.000 |   1234.000 |
|     7 |   0 |   0 |   7 |   0 |   0 | POST   | /register                    | 0.022 |  1.872 |   2.380 | 0.340 | 1.872 |  1.872 |  1.872 |  0.626 |     0.000 |       0.000 |        0.000 |      0.000 |
|     1 |   0 |   1 |   0 |   0 |   0 | GET    | /initialize                  | 0.032 |  0.032 |   0.032 | 0.032 | 0.032 |  0.032 |  0.032 |  0.000 |     0.000 |       0.000 |        0.000 |      0.000 |
|     1 |   0 |   0 |   1 |   0 |   0 | GET    | /logout                      | 0.003 |  0.003 |   0.003 | 0.003 | 0.003 |  0.003 |  0.003 |  0.000 |     0.000 |       0.000 |        0.000 |      0.000 |
+-------+-----+-----+-----+-----+-----+--------+------------------------------+-------+--------+---------+-------+-------+--------+--------+--------+-----------+-------------+--------------+------------+
```

- 画像ファイルの取得に時間がかかっている
  - MAX で 6 秒とかかかってる時もある
  - DB に画像ファイルを raw データで保存していそう
    - mediumblob で保存しているこれは、重そう
- あとは、TOP 画面の処理に時間がかかっている

### USE メソッド

![ctop](/memo/images/ctop_ver2.png)

- mysql に対する負荷が高い
